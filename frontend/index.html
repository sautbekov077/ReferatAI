<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>SmartWord ‚Äî —Ä–µ—Ñ–µ—Ä–∞—Ç, —Å—Ç–∞—Ç—å—è, –ª–∞–±. —Ä–∞–±–æ—Ç–∞</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --muted:#94a3b8; --fg:#e2e8f0; --accent:#22c55e; --border:#1f2937; --danger:#ef4444; }
    *{ box-sizing:border-box }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; background:linear-gradient(160deg,#020617 0%,#0b1020 100%); color:var(--fg) }
    header{ padding:20px; border-bottom:1px solid var(--border); background:rgba(2,6,23,.6); backdrop-filter:blur(6px); position:sticky; top:0; z-index:10 }
    .container{ max-width:1100px; margin:0 auto; padding:20px }
    .grid{ display:grid; grid-template-columns:360px 1fr; gap:20px }
    @media (max-width:980px){ .grid{ grid-template-columns:1fr } }
    .panel{ background:linear-gradient(180deg,rgba(17,24,39,.7),rgba(17,24,39,.5)); border:1px solid var(--border); border-radius:14px; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.25) }
    h1{ margin:0; font-size:20px }
    .muted{ color:var(--muted); font-size:13px }
    label{ display:block; margin:12px 0 6px; font-weight:600 }
    input[type="text"], input[type="number"], select, textarea{
      width:100%; padding:10px 12px; border-radius:10px; background:#0b1220; border:1px solid var(--border); color:var(--fg); outline:none
    }
    textarea{ min-height:90px; resize:vertical }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
    .row-3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px }
    .actions{ display:flex; gap:10px; margin-top:16px; flex-wrap:wrap }
    button{ padding:10px 14px; border-radius:10px; border:1px solid var(--border); background:#0b1220; color:var(--fg); cursor:pointer }
    button.primary{ background:linear-gradient(90deg,#16a34a,#22c55e); border:none; color:#06130a }
    button.secondary{ background:#0b1220 }
    button:disabled{ opacity:.6; cursor:not-allowed }
    .result-section h2{ margin:8px 0 10px; font-size:18px }
    .card{ background:linear-gradient(180deg,rgba(11,16,32,.9),rgba(11,16,32,.6)); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:12px }
    .section-title{ font-weight:700; margin:10px 0 6px }
    .error{ color:var(--danger); margin-top:10px; white-space:pre-wrap }
    .success{ color:var(--accent); margin-top:10px }
    .tiny{ font-size:12px; color:var(--muted) }
    .divider{ height:1px; background:var(--border); margin:12px 0 }
  </style>
</head>
<body>
<header>
  <div class="container">
    <h1>SmartWord ‚Äî –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</h1>
    <div class="muted">–¢–∏–ø—ã: —Ä–µ—Ñ–µ—Ä–∞—Ç, —Å—Ç–∞—Ç—å—è, –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è.</div>
  </div>
</header>

<div class="container">
  <div class="grid">
    <div class="panel">
      <label for="docType">–¢–∏–ø –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
      <select id="docType">
        <option value="referat" selected>–†–µ—Ñ–µ—Ä–∞—Ç</option>
        <option value="article_ru">–°—Ç–∞—Ç—å—è (RU)</option>
        <option value="article_en">–°—Ç–∞—Ç—å—è (EN)</option>
        <option value="article_ru_en">–°—Ç–∞—Ç—å—è (RU/EN)</option>
        <option value="lab">–õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞</option>
      </select>

      <label for="topic">–¢–µ–º–∞</label>
      <input id="topic" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–µ—Ç–æ–¥—ã –º–∞—à–∏–Ω–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è" />

      <div class="row">
        <div>
          <label for="pages">–°—Ç—Ä–∞–Ω–∏—Ü</label>
          <input id="pages" type="number" min="1" max="40" value="8" />
        </div>
        <div>
          <label for="outlineDepth">–ì–ª—É–±–∏–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã</label>
          <select id="outlineDepth">
            <option value="1">–¢–æ–ª—å–∫–æ —Ä–∞–∑–¥–µ–ª—ã</option>
            <option value="2" selected>–†–∞–∑–¥–µ–ª—ã –∏ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã</option>
            <option value="3">–î–æ –ø–æ–¥–ø—É–Ω–∫—Ç–æ–≤</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="style">–°—Ç–∏–ª—å</label>
          <select id="style">
            <option value="academic" selected>–ê–∫–∞–¥–µ–º–∏—á–µ—Å–∫–∏–π</option>
            <option value="concise">–ö—Ä–∞—Ç–∫–∏–π</option>
            <option value="explanatory">–û–±—ä—è—Å–Ω–∏—Ç–µ–ª—å–Ω—ã–π</option>
          </select>
        </div>
        <div>
          <label for="locale">–Ø–∑—ã–∫</label>
          <select id="locale">
            <option value="ru" selected>–†—É—Å—Å–∫–∏–π</option>
            <option value="en">English</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="model">–ú–æ–¥–µ–ª—å (–æ–ø—Ü.)</label>
          <input id="model" type="text" placeholder="meta-llama/llama-3.1-70b-instruct" />
        </div>
        <div>
          <label for="includeToc">–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</label>
          <select id="includeToc">
            <option value="true" selected>–í–∫–ª—é—á–∏—Ç—å</option>
            <option value="false">–ù–µ –≤–∫–ª—é—á–∞—Ç—å</option>
          </select>
        </div>
      </div>

      <div class="divider"></div>

      <label for="requirements">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–∏–º–µ—á–∞–Ω–∏—è (–æ–ø—Ü.)</label>
      <textarea id="requirements" placeholder="–ù–∞–ø—Ä.: –æ–±—ä–µ–º 8‚Äì12 —Å—Ç—Ä., –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã, —Å–æ—Å–ª–∞—Ç—å—Å—è –Ω–∞ –ì–û–°–¢..."></textarea>

      <div id="labFields" style="display:none">
        <div class="divider"></div>
        <label for="labDiscipline">–î–∏—Å—Ü–∏–ø–ª–∏–Ω–∞ (–ª–∞–±.)</label>
        <input id="labDiscipline" type="text" placeholder="–ù–∞–ø—Ä.: –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–∞" />
        <label for="labVariant">–í–∞—Ä–∏–∞–Ω—Ç/‚Ññ —Ä–∞–±–æ—Ç—ã (–ª–∞–±.)</label>
        <input id="labVariant" type="text" placeholder="–ù–∞–ø—Ä.: ‚Ññ3" />
        <label for="labGoal">–¶–µ–ª—å —Ä–∞–±–æ—Ç—ã (–ª–∞–±.)</label>
        <input id="labGoal" type="text" placeholder="–ß–µ—Ç–∫–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ —Ü–µ–ª—å" />
        <label for="labEquipment">–û–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ/–ü–û (–ª–∞–±.)</label>
        <input id="labEquipment" type="text" placeholder="–ù–∞–ø—Ä.: Python 3.11, NumPy, Jupyter" />
      </div>

      <div class="divider"></div>

      <div class="row-3">
        <div>
          <label for="fontName">–®—Ä–∏—Ñ—Ç</label>
          <select id="fontName">
            <option value="Times New Roman" selected>Times New Roman</option>
            <option value="Arial">Arial</option>
            <option value="Calibri">Calibri</option>
          </select>
        </div>
        <div>
          <label for="fontSize">–ö–µ–≥–ª—å</label>
          <input id="fontSize" type="number" min="10" max="16" value="12" />
        </div>
        <div>
          <label for="lineSpacing">–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π</label>
          <select id="lineSpacing">
            <option value="1.15" selected>1.15</option>
            <option value="1.5">1.5</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="margins">–ü–æ–ª—è (—Å–º)</label>
          <input id="margins" type="number" step="0.5" min="1" max="3" value="2.0" />
        </div>
      </div>

      <div class="actions">
        <button id="genBtn" class="primary" type="button" onclick="generate()">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å</button>
        <button id="exportBtn" class="secondary" type="button" onclick="exportDocx()">–≠–∫—Å–ø–æ—Ä—Ç DOCX</button>
      </div>

      <div id="status" class="tiny"></div>
      <div id="error" class="error"></div>
      <div id="success" class="success"></div>
    </div>

    <div class="panel result-section">
      <h2>–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä</h2>
      <div id="result"></div>
    </div>
  </div>
</div>

<script>
  // ======== –ù–ê–°–¢–†–û–ô–ö–ê –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ì–û –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–≠–ö–ï–ù–î–£ ========
  // –ï—Å–ª–∏ —Ñ—Ä–æ–Ω—Ç —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç –æ—Ç–¥–µ–ª—å–Ω–æ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞ Render Pages), –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å API URL.
  // –ù–∞–ø—Ä–∏–º–µ—Ä: const BASE_URL = "https://smartword-backend.onrender.com";
  // –ò–Ω–∞—á–µ ‚Äî –±–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–π origin.
  const BASE_URL = window.location.origin.includes('render.com')
    ? 'https://referatai.onrender.com'  // üëâ –∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π –∞–¥—Ä–µ—Å –±—ç–∫–µ–Ω–¥–∞ Render
    : window.location.origin;

  // ======== –≠–õ–ï–ú–ï–ù–¢–´ UI ========
  const docTypeEl = document.getElementById('docType');
  docTypeEl.addEventListener('change', () => {
    document.getElementById('labFields').style.display = docTypeEl.value === 'lab' ? '' : 'none';
  });

  function uiLock(lock){
    document.getElementById('genBtn').disabled = lock;
    document.getElementById('exportBtn').disabled = lock || !window.generatedEssay;
  }
  function setStatus(t){ document.getElementById('status').textContent = t || '' }
  function setError(t){ document.getElementById('error').textContent = t || '' }
  function setSuccess(t){ document.getElementById('success').textContent = t || '' }

  // ======== –°–ë–û–† –ú–ï–¢–ê–î–ê–ù–ù–´–• –î–õ–Ø –õ–ê–ë–û–†–ê–¢–û–†–ù–û–ô ========
  function collectLabMeta(){
    if (document.getElementById('docType').value !== 'lab') return null;
    return {
      discipline: document.getElementById('labDiscipline').value.trim() || null,
      variant: document.getElementById('labVariant').value.trim() || null,
      goal: document.getElementById('labGoal').value.trim() || null,
      equipment: document.getElementById('labEquipment').value.trim() || null,
    };
  }

  // ======== –ì–ï–ù–ï–†–ê–¶–ò–Ø –î–û–ö–£–ú–ï–ù–¢–ê ========
  async function generate(){
    setError(''); setSuccess('');
    const topic = document.getElementById('topic').value.trim();
    if (!topic){ setError('–£–∫–∞–∂–∏—Ç–µ —Ç–µ–º—É'); return; }

    const body = {
      topic,
      doc_type: document.getElementById('docType').value,
      locale: document.getElementById('locale').value,
      style: document.getElementById('style').value,
      outline_depth: parseInt(document.getElementById('outlineDepth').value || '2', 10),
      requirements: document.getElementById('requirements').value.trim() || null,
      lab_meta: collectLabMeta(),
      model: (document.getElementById('model').value.trim() || null),
      page_target: parseInt(document.getElementById('pages').value || '8', 10)
    };

    uiLock(true); setStatus('–ì–µ–Ω–µ—Ä–∞—Ü–∏—è‚Ä¶');

    try {
      const r = await fetch(`${BASE_URL}/generate`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!r.ok) throw new Error(await r.text() || '–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ —Å–µ—Ä–≤–µ—Ä—É');

      const data = await r.json();
      if (!data.essay) throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –≤–µ—Ä–Ω—É–ª —Ç–µ–∫—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–∞');

      window.generatedEssay = data.essay;
      renderEssay(data.essay);
      setSuccess('–ì–æ—Ç–æ–≤–æ');
    } catch(e) {
      setError('–û—à–∏–±–∫–∞: ' + String(e.message || e));
      console.error(e);
    } finally {
      uiLock(false); setStatus('');
    }
  }

  // ======== –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–ê ========
  function renderEssay(root){
    const container = document.getElementById('result');
    container.innerHTML = '';
    if (!root){ container.textContent = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; return; }
    const card = document.createElement('div');
    card.className = 'card';
    addSection(card, root, 1);
    container.appendChild(card);
  }

  function addSection(parent, sec, level){
    const t = document.createElement('div');
    t.className = 'section-title';
    t.textContent = sec.title || `–†–∞–∑–¥–µ–ª ${level}`;
    parent.appendChild(t);
    (sec.paragraphs || []).forEach(p=>{
      const el = document.createElement('p'); el.textContent = p; parent.appendChild(el);
    });
    (sec.subsections || []).forEach(sub=> addSection(parent, sub, level+1));
  }

  // ======== –≠–ö–°–ü–û–†–¢ –í DOCX ========
  async function exportDocx(){
    setError(''); setSuccess('');
    if (!window.generatedEssay){ setError('–°–Ω–∞—á–∞–ª–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç'); return; }

    const body = {
      topic: document.getElementById('topic').value.trim(),
      essay: window.generatedEssay,
      include_toc: document.getElementById('includeToc').value === 'true',
      line_spacing: parseFloat(document.getElementById('lineSpacing').value || '1.15'),
      font_name: document.getElementById('fontName').value,
      font_size_pt: parseInt(document.getElementById('fontSize').value || '12', 10),
      margins_cm: parseFloat(document.getElementById('margins').value || '2.0'),
      doc_type: document.getElementById('docType').value,
      page_target: parseInt(document.getElementById('pages').value || '8', 10)
    };

    uiLock(true); setStatus('–≠–∫—Å–ø–æ—Ä—Ç DOCX‚Ä¶');

    try {
      const r = await fetch(`${BASE_URL}/export-docx`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      if (!r.ok) throw new Error(await r.text() || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ');

      const blob = await r.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${body.doc_type || 'document'}.docx`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setSuccess('DOCX —Å–æ—Ö—Ä–∞–Ω—ë–Ω');
    } catch(e) {
      setError('–û—à–∏–±–∫–∞: ' + String(e.message || e));
      console.error(e);
    } finally {
      uiLock(false); setStatus('');
    }
  }

  // ======== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ========
  document.getElementById('labFields').style.display = docTypeEl.value === 'lab' ? '' : 'none';
  uiLock(false);
</script>

</body>
</html>
